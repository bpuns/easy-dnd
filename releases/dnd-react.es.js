import{createContext as t,PureComponent as e,createElement as s,useContext as r,useRef as i,useMemo as o,useEffect as n,useLayoutEffect as a}from'react';var h;function d(t,e,s,r){if('a'===s&&!r)throw new TypeError('Private accessor was defined without a getter');if('function'==typeof e?t!==e||!r:!e.has(t))throw new TypeError('Cannot read private member from an object whose class did not declare it');return'm'===s?r:'a'===s?r.call(t):r?r.value:e.get(t)}function c(t,e,s,r,i){if('m'===r)throw new TypeError('Private method is not writable');if('a'===r&&!i)throw new TypeError('Private accessor was defined without a setter');if('function'==typeof e?t!==e||!i:!e.has(t))throw new TypeError('Cannot write private member to an object whose class did not declare it');return'a'===r?i.call(t,s):i?i.value=s:e.set(t,s),s}!function(t){t.SCOPE='scope',t.SWARAJ='swaraj'}(h||(h={})),'function'==typeof SuppressedError&&SuppressedError;const l=Symbol('bind-drag'),g=Symbol('easy-dnd');function f(t){return t instanceof HTMLElement}function m(t){const e=()=>t.dropDom.getBoundingClientRect(),s=()=>t.context,r={event:null,getContext:s,getDropInstance:()=>s().dropInstance,getDragType:()=>s().dragType,getDragData:()=>s().dragData};return{...r,getDragDom:()=>s().dragDom,getDomRect:e,isOverTop:(t,r)=>{const{y:i,height:o}=t||e();return s().dragCoord.y<i+o/(r?3:2)},isOverBottom:(t,r)=>{const{y:i,height:o}=t||e();return s().dragCoord.y>i+o/(r?1.5:2)},isOverLeft:(t,r)=>{const{x:i,width:o}=t||e();return s().dragCoord.x<i+o/(r?3:2)},isOverRight:(t,r)=>{const{x:i,width:o}=t||e();return s().dragCoord.x>i+o/(r?1.5:2)},isOverRowCenter(t){return t=t||e(),!this.isOverTop(t,!0)&&!this.isOverBottom(t,!0)},isOverColumnCenter(t){return t=t||e(),!this.isOverLeft(t,!0)&&!this.isOverRight(t,!0)},getRubbish:()=>s().getRubbish(),_s:r}}function p({dndMode:t=h.SWARAJ,delay:e=0}={}){(e<0||isNaN(e))&&(e=0);const s={};return{dndMode:t,delay:e,dropInstance:null,dragCoord:{x:0,y:0},dragType:null,dragDom:null,dragData:null,enterDom:null,dragItemDragStarts:new Set,dragItemDragEnds:new Set,dropItemDragStarts:new Set,dropItemDragEnds:new Set,getRubbish:()=>s}}function u(t){const e=()=>t.context;return{event:null,getContext:e,getRubbish:()=>e().getRubbish()}}var v,D,w,E,x,b,y,k,M,W,S,L,I,T,C,P,R,O,A,F,N,j,B,J,X,Y,_,H;class q{constructor(t){this.monitor=u(this),v.set(this,!0),D.set(this,!1),w.set(this,!0),E.set(this,!1),x.set(this,void 0),this.registerDom=t=>(this.dragDom=t,f(t)&&(t[l]=!0),this),b.set(this,(t=>{const{dragDom:e}=this;f(e)?t?(e.setAttribute('draggable','true'),e.style.cursor='move'):(e.removeAttribute('draggable'),e.style.removeProperty('cursor')):c(this,w,t,'f')})),y.set(this,((t,e)=>{var s;const r=d(this,x,'f')[e];r&&(null===(s=this.dragDom)||void 0===s||s.classList[t](r))})),this.subscribe=()=>{if(d(this,E,'f'))return;const{dragDom:t,context:e}=this;if(!f(t))throw new Error('class Drag调用subscribe方法前必须调用registerDom方法');return d(this,b,'f').call(this,c(this,w,c(this,E,!0,'f'),'f')),e.dragItemDragStarts.add(d(this,P,'f')),e.dragItemDragEnds.add(d(this,R,'f')),d(this,T,'f').call(this),d(this,x,'f').hover&&t.addEventListener('mouseleave',d(this,M,'f')),t.addEventListener('dragstart',d(this,W,'f')),t.addEventListener('drag',d(this,S,'f')),t.addEventListener('dragend',d(this,L,'f')),this},this.unSubscribe=()=>{if(!d(this,E,'f'))return;const{dragDom:t,context:e}=this;t&&(d(this,b,'f').call(this,t[l]=c(this,w,c(this,E,!1,'f'),'f')),!d(this,v,'f')&&d(this,L,'f').call(this,this.monitor.event),d(this,C,'f').call(this),d(this,x,'f').hover&&t.removeEventListener('mouseleave',d(this,M,'f')),t.removeEventListener('dragstart',d(this,W,'f')),t.removeEventListener('drag',d(this,S,'f')),t.removeEventListener('dragend',d(this,L,'f')),this.dragDom=null),e.dragItemDragEnds.delete(d(this,R,'f')),e.dragItemDragStarts.delete(d(this,P,'f'))},k.set(this,(()=>{!this.context.dragDom&&d(this,w,'f')&&(c(this,D,!0,'f'),d(this,y,'f').call(this,'add','hover'))})),M.set(this,(()=>{d(this,D,'f')&&d(this,w,'f')&&(c(this,D,!1,'f'),d(this,y,'f').call(this,'remove','hover'))})),W.set(this,(t=>{var e;const{monitor:s,context:r,params:i,config:o}=this;t.stopPropagation(),s.event=t,r.dragType=o.type,r.dragDom=this.dragDom,r.dropInstance=null,r.dragData=null===(e=o.data)||void 0===e?void 0:e.call(o),c(this,v,!1,'f');const n=Array.from(this.dragDom.children);let a,h;for(a of n)a.style.pointerEvents='none';for(h of(i.dragStart&&i.dragStart(s),this.context.dragItemDragStarts))h();for(h of this.context.dropItemDragStarts)h();h=null,d(this,y,'f').call(this,'add','dragging')})),S.set(this,(t=>{const{dragCoord:e}=this.context;e.x=t.clientX,e.y=t.clientY,this.params.drag&&(this.monitor.event=t,this.params.drag(this.monitor))})),L.set(this,(t=>{const{monitor:e,params:s}=this;c(this,v,!0,'f'),e.event=t;const r=Array.from(this.dragDom.children);let i,o;for(i of r)i.style.pointerEvents='auto';for(o of(s.dragEnd&&s.dragEnd(e),this.context.dragItemDragEnds))o();for(o of this.context.dropItemDragEnds)o();d(this,I,'f').call(this),d(this,y,'f').call(this,'remove','dragging')})),I.set(this,(()=>{this.context.dragDom=null,this.context.dragData=null,this.context.enterDom=null,this.monitor.event=null})),T.set(this,(()=>{d(this,x,'f').hover&&this.dragDom&&this.dragDom.addEventListener('mouseenter',d(this,k,'f'))})),C.set(this,(()=>{d(this,x,'f').hover&&this.dragDom&&this.dragDom.removeEventListener('mouseenter',d(this,k,'f'))})),P.set(this,(()=>{d(this,M,'f').call(this),d(this,C,'f').call(this)})),R.set(this,(()=>{setTimeout((()=>d(this,T,'f').call(this)))})),this.params=t,this.config=t.config;const{className:e,context:s,defaultDraggable:r}=t.config;this.context=s,c(this,x,e||{},'f'),c(this,w,null==r||r,'f')}get draggable(){return d(this,w,'f')}set draggable(t){t!==d(this,w,'f')&&d(this,b,'f').call(this,c(this,w,t,'f'))}}v=new WeakMap,D=new WeakMap,w=new WeakMap,E=new WeakMap,x=new WeakMap,b=new WeakMap,y=new WeakMap,k=new WeakMap,M=new WeakMap,W=new WeakMap,S=new WeakMap,L=new WeakMap,I=new WeakMap,T=new WeakMap,C=new WeakMap,P=new WeakMap,R=new WeakMap;class z{constructor(t){this.monitor=m(this),this.isEnter=!1,this.prePosition={x:0,y:0},O.set(this,0),A.set(this,!1),F.set(this,void 0),N.set(this,!1),this.registerDom=t=>(this.dropDom=t,this),this.subscribe=()=>{if(d(this,A,'f'))return;const{dropDom:t}=this;if(!f(t))throw new Error('class Drop调用subscribe方法前必须调用registerDom方法');return c(this,A,!0,'f'),this.context.dropItemDragStarts.add(d(this,_,'f')),this.context.dropItemDragEnds.add(d(this,H,'f')),t.addEventListener('dragenter',d(this,B,'f')),t.addEventListener('dragover',d(this,J,'f')),t.addEventListener('dragleave',d(this,X,'f')),t.addEventListener('drop',d(this,Y,'f')),this},this.unSubscribe=()=>{if(!d(this,A,'f'))return;const{dropDom:t}=this;t&&(c(this,A,!1,'f'),this.context.dropItemDragEnds.delete(d(this,H,'f')),this.context.dropItemDragStarts.delete(d(this,_,'f')),t.removeEventListener('dragenter',d(this,B,'f')),t.removeEventListener('dragover',d(this,J,'f')),t.removeEventListener('dragleave',d(this,X,'f')),t.removeEventListener('drop',d(this,Y,'f')),this.dropDom=null)},j.set(this,((t,e)=>{var s;const r=d(this,F,'f')[e];r&&(null===(s=this.dropDom)||void 0===s||s.classList[t](r))})),this.canDrop=t=>{const{dragDom:e}=this.context;return!!e&&(this.monitor.event=t,(!this.dropDom[l]||e!==this.dropDom)&&(!!this.config.acceptType.has(this.monitor.getDragType())&&(this.config.canDrop?!!this.config.canDrop(this.monitor._s)&&(null==t||t.preventDefault(),!0):(null==t||t.preventDefault(),!0))))},this.stopPropagation=t=>{this.context.dndMode===h.SWARAJ&&t.stopPropagation()},B.set(this,(t=>{var e,s;if(this.stopPropagation(t),this.canDrop(t)&&0===(c(this,O,(s=d(this,O,'f'),e=s++,s),'f'),e)){this.context.enterDom=this.dropDom;const t=()=>{var t,e;this.enterTimer=null,this.context.enterDom===this.dropDom&&(this.isEnter=!0,null===(e=(t=this.params).dragEnter)||void 0===e||e.call(t,this.monitor),d(this,j,'f').call(this,'add','dragEnter'))},e=this.context.delay;e>0?this.enterTimer=setTimeout(t,e):t()}})),J.set(this,(t=>{var e,s;if(this.stopPropagation(t),this.canDrop(t)&&this.isEnter){const r=this.prePosition;r.x===t.clientX&&r.y===t.clientY||(r.x=t.clientX,r.y=t.clientY,null===(s=(e=this.params).dragOver)||void 0===s||s.call(e,this.monitor))}})),X.set(this,(t=>{var e,s,r;this.stopPropagation(t),this.canDrop(t)&&(c(this,O,(r=d(this,O,'f'),--r),'f')||(this.enterTimer?clearTimeout(this.enterTimer):this.isEnter&&(this.isEnter=!1,d(this,j,'f').call(this,'remove','dragEnter'),null===(s=(e=this.params).dragLeave)||void 0===s||s.call(e,this.monitor))))})),Y.set(this,(t=>{var e,s;this.stopPropagation(t),this.canDrop(t)&&(this.context.dropInstance=this,d(this,j,'f').call(this,'remove','dragEnter'),null===(s=(e=this.params).drop)||void 0===s||s.call(e,this.monitor))})),_.set(this,(()=>{const{dragStart:t}=this.params;c(this,N,this.canDrop(),'f'),d(this,N,'f')&&(null==t||t(this.monitor),d(this,j,'f').call(this,'add','canDrop'))})),H.set(this,(()=>{const{dragEnd:t}=this.params;t&&d(this,N,'f')&&(null==t||t(this.monitor)),d(this,j,'f').call(this,'remove','canDrop'),c(this,O,0,'f'),this.isEnter=!1,this.monitor.event=null})),this.params=t,this.config=t.config,c(this,F,this.config.className||{},'f'),this.context=this.config.context}}O=new WeakMap,A=new WeakMap,F=new WeakMap,N=new WeakMap,j=new WeakMap,B=new WeakMap,J=new WeakMap,X=new WeakMap,Y=new WeakMap,_=new WeakMap,H=new WeakMap;const G=t(null);class K extends e{constructor(t){super(t),this.dndCtx=p(t)}render(){return s(G.Provider,{value:this.dndCtx,children:this.props.children})}}class Q extends q{constructor(){super(...arguments),this.hooksFirst=!0,this.dragRef=t=>(this.registerDom(t),t)}}class U extends z{constructor(){super(...arguments),this.hooksFirst=!0,this.dropRef=t=>{if('function'==typeof t)return e=>{this.registerDom(t(e))};this.registerDom(t)}}}const V=[],Z=['dragStart','dragEnd','drag'];function $(t,e=V){const s=r(G),h=i(null),d=o((()=>{const e=t();return e.config.context=s,new Q(e)}),[]);return n((()=>{if(d.hooksFirst)d.hooksFirst=!1;else{const{params:e}=d,s=t();for(let t of Z)e[t]&&(e[t]=s[t]);e.config.data=s.config.data}}),e),a((()=>(null===d.dragDom&&(d.dragDom=h.current),h.current=d.dragDom,d.subscribe(),()=>d.unSubscribe())),[]),d}const tt=['dragStart','dragEnd','drop','dragEnter','dragOver','dragLeave'];function et(t,e=V){const s=r(G),h=i(null),d=o((()=>{const e=t();return e.config.context=s,new U(e)}),[]);return n((()=>{if(d.hooksFirst)d.hooksFirst=!1;else{const{params:e}=d,s=t();for(let t of tt)e[t]&&(e[t]=s[t]);e.config.canDrop=s.config.canDrop}}),e),a((()=>(null===d.dropDom&&(d.dropDom=h.current),h.current=d.dropDom,d.subscribe(),()=>d.unSubscribe())),[]),d}export{l as BIND_DRAG,g as DND_CTX,h as DND_MODE,K as DndProvider,Q as Drag,q as DragCore,U as Drop,z as DropCore,u as createDragMonitor,m as createDropMonitor,p as createProvider,f as isElement,$ as useDrag,et as useDrop};
